/**
 * SMS Permission Fix Verification Test
 * Tests the comprehensive SMS permission handling for Android 6.0+ and 11+
 */

const fs = require('fs');
const path = require('path');

async function testSMSPermissionFix() {
  console.log('üîê SMS Permission Fix Verification Test\n');
  console.log('=' .repeat(60));

  const results = {
    passed: 0,
    failed: 0,
    details: []
  };

  // Test 1: Check Android Manifest SMS Permissions
  console.log('üì± Testing Android Manifest SMS Permissions...');
  try {
    const manifestPath = 'android/app/src/main/AndroidManifest.xml';
    const manifestContent = fs.readFileSync(manifestPath, 'utf8');
    
    const requiredPermissions = [
      'android.permission.READ_SMS',
      'android.permission.RECEIVE_SMS',
      'android.permission.SEND_SMS'
    ];
    
    const missingPermissions = requiredPermissions.filter(permission => 
      !manifestContent.includes(permission)
    );
    
    if (missingPermissions.length === 0) {
      console.log('‚úÖ All SMS permissions present in AndroidManifest.xml');
      console.log('  - READ_SMS: ‚úì');
      console.log('  - RECEIVE_SMS: ‚úì');
      console.log('  - SEND_SMS: ‚úì');
      results.passed++;
      results.details.push('‚úÖ Android Manifest SMS permissions configured');
    } else {
      console.log('‚ùå Missing SMS permissions:', missingPermissions);
      results.failed++;
      results.details.push('‚ùå Missing SMS permissions in manifest');
    }
  } catch (error) {
    console.log('‚ùå Manifest check failed:', error.message);
    results.failed++;
    results.details.push('‚ùå Manifest check failed');
  }

  // Test 2: Check Android 11+ Query Permissions
  console.log('\nüì± Testing Android 11+ Query Permissions...');
  try {
    const manifestPath = 'android/app/src/main/AndroidManifest.xml';
    const manifestContent = fs.readFileSync(manifestPath, 'utf8');
    
    const hasQueriesSection = manifestContent.includes('<queries>');
    const hasSMSQuery = manifestContent.includes('android.intent.action.SENDTO') && 
                       manifestContent.includes('sms');
    
    if (hasQueriesSection && hasSMSQuery) {
      console.log('‚úÖ Android 11+ queries configured correctly');
      console.log('  - SMS queries: ‚úì');
      console.log('  - SENDTO action: ‚úì');
      results.passed++;
      results.details.push('‚úÖ Android 11+ query permissions configured');
    } else {
      console.log('‚ùå Android 11+ queries missing or incomplete');
      results.failed++;
      results.details.push('‚ùå Android 11+ query permissions missing');
    }
  } catch (error) {
    console.log('‚ùå Queries check failed:', error.message);
    results.failed++;
    results.details.push('‚ùå Queries check failed');
  }

  // Test 3: Check Target SDK Version
  console.log('\nüéØ Testing Target SDK Version...');
  try {
    const gradlePropsPath = 'android/gradle.properties';
    const gradleContent = fs.readFileSync(gradlePropsPath, 'utf8');
    
    const targetSdkMatch = gradleContent.match(/android\.targetSdkVersion=(\d+)/);
    const targetSdk = targetSdkMatch ? parseInt(targetSdkMatch[1]) : 0;
    
    if (targetSdk >= 33) {
      console.log(`‚úÖ Target SDK Version: ${targetSdk} (Android 13+)`);
      console.log('  - Supports modern permission handling: ‚úì');
      results.passed++;
      results.details.push('‚úÖ Target SDK version appropriate for modern permissions');
    } else {
      console.log(`‚ö†Ô∏è Target SDK Version: ${targetSdk} (Consider updating to 33+)`);
      results.details.push('‚ö†Ô∏è Target SDK version could be updated');
    }
  } catch (error) {
    console.log('‚ùå Target SDK check failed:', error.message);
    results.failed++;
    results.details.push('‚ùå Target SDK check failed');
  }

  // Test 4: Check SMS Reader Service Implementation
  console.log('\nüîß Testing SMS Reader Service Implementation...');
  try {
    const servicePath = 'src/services/SMSReaderService.ts';
    const serviceContent = fs.readFileSync(servicePath, 'utf8');
    
    const hasPermissionCheck = serviceContent.includes('checkCurrentSMSPermissions');
    const hasPermissionRequest = serviceContent.includes('requestSMSPermissionsWithContext');
    const hasRationale = serviceContent.includes('showPermissionRationale');
    const hasSettingsRedirect = serviceContent.includes('handlePermissionPermanentlyDenied');
    const hasProperErrorHandling = serviceContent.includes('NEVER_ASK_AGAIN');
    
    if (hasPermissionCheck && hasPermissionRequest && hasRationale && hasSettingsRedirect && hasProperErrorHandling) {
      console.log('‚úÖ SMS Reader Service implementation complete');
      console.log('  - Permission status checking: ‚úì');
      console.log('  - Context-aware permission requests: ‚úì');
      console.log('  - User rationale dialogs: ‚úì');
      console.log('  - Settings redirect for denied permissions: ‚úì');
      console.log('  - NEVER_ASK_AGAIN handling: ‚úì');
      results.passed++;
      results.details.push('‚úÖ SMS Reader Service fully implemented');
    } else {
      console.log('‚ùå SMS Reader Service implementation incomplete');
      console.log(`  - Permission checking: ${hasPermissionCheck ? '‚úì' : '‚úó'}`);
      console.log(`  - Context-aware requests: ${hasPermissionRequest ? '‚úì' : '‚úó'}`);
      console.log(`  - User rationale: ${hasRationale ? '‚úì' : '‚úó'}`);
      console.log(`  - Settings redirect: ${hasSettingsRedirect ? '‚úì' : '‚úó'}`);
      console.log(`  - NEVER_ASK_AGAIN: ${hasProperErrorHandling ? '‚úì' : '‚úó'}`);
      results.failed++;
      results.details.push('‚ùå SMS Reader Service implementation incomplete');
    }
  } catch (error) {
    console.log('‚ùå Service implementation check failed:', error.message);
    results.failed++;
    results.details.push('‚ùå Service implementation check failed');
  }

  // Test 5: Check App Configuration
  console.log('\n‚öôÔ∏è Testing App Configuration...');
  try {
    const appConfigPath = 'app.config.js';
    const appConfigContent = fs.readFileSync(appConfigPath, 'utf8');
    
    const hasSMSPermissions = appConfigContent.includes('READ_SMS') && 
                              appConfigContent.includes('RECEIVE_SMS');
    
    if (hasSMSPermissions) {
      console.log('‚úÖ App configuration includes SMS permissions');
      results.passed++;
      results.details.push('‚úÖ App config SMS permissions configured');
    } else {
      console.log('‚ùå App configuration missing SMS permissions');
      results.failed++;
      results.details.push('‚ùå App config SMS permissions missing');
    }
  } catch (error) {
    console.log('‚ùå App config check failed:', error.message);
    results.failed++;
    results.details.push('‚ùå App config check failed');
  }

  // Test 6: Check Package Dependencies
  console.log('\nüì¶ Testing Package Dependencies...');
  try {
    const packagePath = 'package.json';
    const packageContent = fs.readFileSync(packagePath, 'utf8');
    const packageJson = JSON.parse(packageContent);
    
    const hasReactNative = packageJson.dependencies['react-native'];
    const hasExpo = packageJson.dependencies['expo'];
    const hasSMSRetriever = packageJson.dependencies['react-native-sms-retriever'];
    
    console.log(`React Native: ${hasReactNative ? '‚úì' : '‚úó'}`);
    console.log(`Expo: ${hasExpo ? '‚úì' : '‚úó'}`);
    console.log(`SMS Retriever: ${hasSMSRetriever ? '‚úì' : '‚ö†Ô∏è (Optional but recommended)'}`);
    
    if (hasReactNative && hasExpo) {
      results.passed++;
      results.details.push('‚úÖ Core dependencies available');
    } else {
      results.failed++;
      results.details.push('‚ùå Missing core dependencies');
    }
    
    if (!hasSMSRetriever) {
      results.details.push('‚ö†Ô∏è react-native-sms-retriever not installed (fallback methods available)');
    }
  } catch (error) {
    console.log('‚ùå Package dependencies check failed:', error.message);
    results.failed++;
    results.details.push('‚ùå Package dependencies check failed');
  }

  // Test Summary
  console.log('\nüìä SMS Permission Fix Test Summary');
  console.log('=' .repeat(60));
  console.log(`‚úÖ Tests Passed: ${results.passed}`);
  console.log(`‚ùå Tests Failed: ${results.failed}`);
  console.log(`üìã Total Tests: ${results.passed + results.failed}`);

  console.log('\nüìù Detailed Results:');
  results.details.forEach(detail => console.log(`  ${detail}`));

  // Implementation Guide
  console.log('\nüõ†Ô∏è SMS Permission Implementation Guide');
  console.log('=' .repeat(60));
  console.log('The SMS permission system now includes:');
  console.log('');
  console.log('1. üì± COMPREHENSIVE PERMISSION HANDLING');
  console.log('   ‚Ä¢ Pre-checks current permission status');
  console.log('   ‚Ä¢ Shows user-friendly rationale dialogs');
  console.log('   ‚Ä¢ Handles all Android permission states');
  console.log('   ‚Ä¢ Redirects to settings for permanently denied permissions');
  console.log('');
  console.log('2. üîê ANDROID 14 (API 34) COMPATIBILITY');
  console.log('   ‚Ä¢ Proper targeting of Android 14');
  console.log('   ‚Ä¢ Enhanced permission context messages');
  console.log('   ‚Ä¢ User privacy-focused permission requests');
  console.log('');
  console.log('3. üìã ANDROID 11+ QUERY PERMISSIONS');
  console.log('   ‚Ä¢ Allows querying SMS-related apps');
  console.log('   ‚Ä¢ Required for Android 11+ (API 30+)');
  console.log('   ‚Ä¢ Enables proper SMS app interaction');
  console.log('');
  console.log('4. üõ°Ô∏è PRIVACY-FIRST APPROACH');
  console.log('   ‚Ä¢ Clear explanation of data usage');
  console.log('   ‚Ä¢ Manual scanning only (no automatic reading)');
  console.log('   ‚Ä¢ Local analysis (no external data sending)');
  console.log('   ‚Ä¢ User-controlled permission granting');
  console.log('');
  console.log('5. üîß USAGE INSTRUCTIONS');
  console.log('   ‚Ä¢ Import: import { smsReaderService } from "../services/SMSReaderService"');
  console.log('   ‚Ä¢ Initialize: await smsReaderService.initialize()');
  console.log('   ‚Ä¢ Check status: smsReaderService.isReady()');
  console.log('   ‚Ä¢ Read SMS: await smsReaderService.getSMSMessages()');
  console.log('');
  console.log('‚úÖ The SMS permission system is now fully compatible with:');
  console.log('   ‚Ä¢ Android 6.0+ (API 23+) runtime permissions');
  console.log('   ‚Ä¢ Android 11+ (API 30+) query restrictions');
  console.log('   ‚Ä¢ Android 14+ (API 34+) enhanced privacy requirements');

  if (results.failed === 0) {
    console.log('\nüéâ ALL TESTS PASSED! SMS permission system is ready for production.');
  } else {
    console.log('\n‚ö†Ô∏è Some tests failed. Please review the implementation before proceeding.');
  }

  return results;
}

// Run the test
testSMSPermissionFix()
  .then(results => {
    console.log('\nüèÅ SMS Permission Fix Test Completed');
    process.exit(results.failed === 0 ? 0 : 1);
  })
  .catch(error => {
    console.error('\n‚ùå Test execution failed:', error);
    process.exit(1);
  }); 